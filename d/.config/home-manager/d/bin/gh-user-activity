#!/usr/bin/env bash

ORG="$1"
USERNAME="$2"
DAYS="${3:-7}"
DATE_SINCE=$(date -d "$DAYS days ago" --iso-8601 2>/dev/null || date -v-${DAYS}d +%Y-%m-%d)

echo "=== Activity for $USERNAME in $ORG (last $DAYS days) ==="
echo

echo "Commits"
gh search commits \
  --owner="$ORG" \
  --author="$USERNAME" \
  --committer-date=">=$DATE_SINCE" \
  --json repository,commit,sha,committer \
  --jq '.[] | "[\(.commit.committer.date)] \(.repository.name): \(.commit.message | split("\n")[0])"'
echo

echo "Pull Requests"
gh api graphql -f query="
{
  search(query: \"org:$ORG updated:>=$DATE_SINCE is:pr\", type: ISSUE, first: 100) {
    nodes {
      ... on PullRequest {
        number
        title
        state
        updatedAt
        author {
          login
        }
        repository {
          name
        }
        comments(first: 100) {
          nodes {
            author {
              login
            }
          }
        }
        reviews(first: 100) {
          nodes {
            author {
              login
            }
          }
        }
        mergedBy {
          login
        }
      }
    }
  }
}" \
  --jq ".data.search.nodes[]
        | select(
            .author.login == \"$USERNAME\" or
            .mergedBy.login == \"$USERNAME\" or
            (.comments.nodes[].author.login | . == \"$USERNAME\") or
            (.reviews.nodes[].author.login | . == \"$USERNAME\")
          )
        | \"[\(.updatedAt)] \(.repository.name)#\(.number): \(.title) (\(.state)) by @\(.author.login)\""
echo

echo "PRs ignored (review requested but not touched)"
gh api graphql -f query="
{
  search(query: \"org:$ORG updated:>=$DATE_SINCE is:pr review-requested:$USERNAME\", type: ISSUE, first: 100) {
    nodes {
      ... on PullRequest {
        number
        title
        state
        updatedAt
        author {
          login
        }
        repository {
          name
        }
        comments(first: 100) {
          nodes {
            author {
              login
            }
          }
        }
        reviews(first: 100) {
          nodes {
            author {
              login
            }
          }
        }
        mergedBy {
          login
        }
      }
    }
  }
}" \
  --jq ".data.search.nodes[]
        | select(
            .author.login != \"$USERNAME\" and
            (.mergedBy.login // \"\" | . != \"$USERNAME\") and
            ((.comments.nodes | map(.author.login) | contains([\"$USERNAME\"])) | not) and
            ((.reviews.nodes | map(.author.login) | contains([\"$USERNAME\"])) | not)
          )
        | \"[\(.updatedAt)] \(.repository.name)#\(.number): \(.title) (\(.state)) by @\(.author.login)\""
echo

echo "Issues"
gh search issues \
  --owner="$ORG" \
  --involves="$USERNAME" \
  --updated=">=$DATE_SINCE" \
  --json number,title,repository,state,updatedAt,author \
  --jq '.[] | "[\(.updatedAt)] \(.repository.name)#\(.number): \(.title) (\(.state)) by @\(.author.login)"'
echo

echo "Comments"
gh api graphql -f query="
{
  search(query: \"org:$ORG commenter:$USERNAME updated:>=$DATE_SINCE\", type: ISSUE, first: 50) {
    nodes {
      ... on Issue {
        number
        title
        updatedAt
        repository {
          name
        }
        comments(last: 10) {
          nodes {
            author {
              login
            }
            createdAt
            body
          }
        }
      }
      ... on PullRequest {
        number
        title
        updatedAt
        repository {
          name
        }
        comments(last: 10) {
          nodes {
            author {
              login
            }
            createdAt
            body
          }
        }
      }
    }
  }
}" \
   --jq ".data.search.nodes[]
         | . as \$issue
         | .comments.nodes[]
         | select(.author.login == \"$USERNAME\")
         | (.body | gsub(\"[\\n\\r]+\"; \" \") | gsub(\" +\"; \" \")) as \$body
         | \"[\(.createdAt) \(\$issue.repository.name)#\(\$issue.number)] \(\$body[:70])\(if (\$body | length) > 70 then \"...\" else \"\" end)\""
